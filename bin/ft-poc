#!/usr/bin/env ruby

require "curb"
require "crack/xml"
require "yaml"
require "addressable/uri"
require "optparse"

CONF = {
  ft: {
    api_url: "http://api.filestube.com",
    api_key: "d395980ed3bb71cfbcbf845ea4a18928"
  }
}

options={}

OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options]"
  opts.on( "-p", "--phrase PHRASE", String, "Phrase to search for" ) do |phrase|
    options[:phrase] = phrase
  end
  opts.on( "-e", "--extension EXTENSION", String, "Optional extension of the files searched using PHRASE" ) do |ext|
    options[:ext] = ext
  end
end.parse!

if options[:phrase].nil? 
  puts "PHRASE is required"
  exit
end

uri = Addressable::URI.parse(CONF[:ft][:api_url])
uri.query_values = {
  key: CONF[:ft][:api_key],
  phrase: options[:phrase],
  extension: ( options[:ext] ? options[:ext] : nil )
}

http = Curl.get(uri.to_s)
result = Crack::XML.parse(http.body_str)

result["answer"]["results"]["hits"].each do |hit|
  puts "name: " + hit["name"]
  puts "ext: " + hit["extension"]
  puts
end
# p uri.to_s



